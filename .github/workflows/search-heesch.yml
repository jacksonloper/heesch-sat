name: Search Polyforms by Heesch

on:
  workflow_dispatch:
    inputs:
      grid_type:
        description: 'Grid type (hex, iamond, omino, octasquare, trihex, abolo, drafter, kite, halfcairo, bevelhex)'
        required: true
        type: choice
        options:
          - hex
          - iamond
          - omino
          - octasquare
          - trihex
          - abolo
          - drafter
          - kite
          - halfcairo
          - bevelhex
      num_cells:
        description: 'Number of cells in polyforms to search'
        required: true
        type: number
      max_results:
        description: 'Maximum number of results to store (default: 3)'
        required: false
        type: number
        default: 3
      force:
        description: 'Force recompute even if already cached'
        required: false
        type: boolean
        default: false
      batch_size:
        description: 'Number of polyforms to process in each batch (default: 10)'
        required: false
        type: number
        default: 10
      json_nup:
        description: 'Minimum Heesch number to include in results (default: 1)'
        required: false
        type: number
        default: 1

jobs:
  search:
    runs-on: ubuntu-latest
    timeout-minutes: 250
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Modal
        run: pip install modal

      - name: Authenticate with Modal
        env:
          MODAL_COMMAND: ${{ secrets.MODAL_COMMAND }}
        run: eval "$MODAL_COMMAND"

      - name: Launch Heesch search job on Modal
        id: search
        run: |
          echo "Launching Heesch search job on Modal..."
          echo "Grid type: ${{ inputs.grid_type }}"
          echo "Number of cells: ${{ inputs.num_cells }}"
          echo "Max results: ${{ inputs.max_results }}"
          echo "Force: ${{ inputs.force }}"
          echo "Batch size: ${{ inputs.batch_size }}"
          echo "json_nup: ${{ inputs.json_nup }}"

          # Call Modal function directly using Python SDK
          python3 << 'EOF'
          from modal import Function
          import json
          import sys
          import os

          # Get reference to the deployed function
          search_fn = Function.from_name("heesch-renderings", "search_heesch")

          # Call the function with parameters (spawn for async execution)
          # Use spawn() to launch the job and get function call ID
          fc = search_fn.spawn(
              grid_type="${{ inputs.grid_type }}",
              num_cells=${{ inputs.num_cells }},
              max_results=${{ inputs.max_results }},
              force=${{ inputs.force == true && 'True' || 'False' }},
              batch_size=${{ inputs.batch_size }},
              json_nup=${{ inputs.json_nup }}
          )

          function_call_id = fc.object_id
          print(f"Search job spawned on Modal (ID: {function_call_id})")

          # Wait for results with timeout (4 hours max)
          try:
              result = fc.get(timeout=14400)
              print("Response:")
              print(json.dumps(result, indent=2))

              status = result.get("status", "unknown")
              results_found = result.get("results_found", 0)

              # Write outputs to GitHub
              github_output = os.environ.get("GITHUB_OUTPUT", "")
              if github_output:
                  with open(github_output, "a") as f:
                      f.write(f"status={status}\n")
                      f.write(f"results_found={results_found}\n")
                      f.write(f"function_call_id={function_call_id}\n")

              if status == "cached":
                  print(f"::notice::Found {results_found} cached polyforms with Heesch >= ${{ inputs.json_nup }}")
              elif status == "completed":
                  print(f"::notice::Search completed! Found {results_found} polyforms with Heesch >= ${{ inputs.json_nup }}")
              elif status == "error":
                  message = result.get("message", "Unknown error")
                  print(f"::error::Search failed: {message}")
                  sys.exit(1)
              else:
                  print(f"::notice::Search status: {status}")

          except TimeoutError:
              print(f"::warning::Search job timed out after 4 hours. Job may still be running on Modal.")
              print(f"Function call ID: {function_call_id}")
              # Write outputs even on timeout
              github_output = os.environ.get("GITHUB_OUTPUT", "")
              if github_output:
                  with open(github_output, "a") as f:
                      f.write(f"status=timeout\n")
                      f.write(f"function_call_id={function_call_id}\n")
          EOF

      - name: Summary
        run: |
          echo "## Heesch Search Job" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Grid Type:** ${{ inputs.grid_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Number of Cells:** ${{ inputs.num_cells }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max Results:** ${{ inputs.max_results }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Batch Size:** ${{ inputs.batch_size }}" >> $GITHUB_STEP_SUMMARY
          echo "- **json_nup:** ${{ inputs.json_nup }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.search.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.search.outputs.status }}" = "cached" ]; then
            echo "Results were already cached. Found **${{ steps.search.outputs.results_found }}** polyforms with Heesch >= ${{ inputs.json_nup }}." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.search.outputs.status }}" = "completed" ]; then
            echo "Search completed! Found **${{ steps.search.outputs.results_found }}** polyforms with Heesch >= ${{ inputs.json_nup }}." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.search.outputs.status }}" = "timeout" ]; then
            echo "Search timed out. Job may still be running on Modal." >> $GITHUB_STEP_SUMMARY
            echo "Function call ID: ${{ steps.search.outputs.function_call_id }}" >> $GITHUB_STEP_SUMMARY
          fi
